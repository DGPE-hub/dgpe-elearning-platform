<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Administration ‚Äì DGPE</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="./style.css">
  <style>
    table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{border:1px solid #ddd;padding:10px;text-align:center;font-size:14px}
    th{background:#0b2a4a;color:#fff}
    .btn{border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .ok{background:#1b5e20;color:#fff}
    .no{background:#c62828;color:#fff}
    .wrap{max-width:1050px;margin:0 auto;padding:0 16px}
    .card{background:rgba(255,255,255,.96);padding:18px;border-radius:14px;margin-top:25px}
    #msg{margin-top:12px;font-weight:700}
  </style>
</head>

<body>

<header class="navbar">
  <div class="wrap">
    <div class="logo-group">
      <img src="assets/img/dgpe-logo.png" class="logo" alt="DGPE">
      <span class="brand">Administration</span>
    </div>
    <nav class="nav">
      <a href="dashboard.html">Dashboard</a>
      <a href="#" class="pill" id="btnLogout">D√©connexion</a>
    </nav>
  </div>
</header>

<section class="wrap">
  <div class="card">
    <h1>üìã Demandes de cr√©ation de compte</h1>
    <p style="opacity:.8;margin-top:-6px">Seules les demandes <b>PENDING</b> s‚Äôaffichent.</p>

    <table>
      <thead>
        <tr>
          <th>Email</th>
          <th>UID</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div id="msg"></div>
  </div>
</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import {
    getFirestore,
    collection,
    query,
    where,
    getDocs,
    doc,
    setDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLeMFoRoclFnfubLqhJBvwtySxLttyHqs",
    authDomain: "dgpe-elearning.firebaseapp.com",
    projectId: "dgpe-elearning",
    storageBucket: "dgpe-elearning.appspot.com",
    messagingSenderId: "564422941000",
    appId: "1:564422941000:web:f5232cd0cebafb6aaf7b7d"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const tbody = document.getElementById("tbody");
  const msg = document.getElementById("msg");

  function setMsg(t, ok=true){
    msg.style.color = ok ? "#1b5e20" : "#c62828";
    msg.textContent = t;
  }

  async function loadPending(){
    tbody.innerHTML = "<tr><td colspan='4'>Chargement‚Ä¶</td></tr>";

    const q = query(collection(db, "user_requests"), where("status", "==", "PENDING"));
    const snap = await getDocs(q);

    if (snap.empty){
      tbody.innerHTML = "<tr><td colspan='4'>Aucune demande en attente</td></tr>";
      return;
    }

    tbody.innerHTML = "";
    snap.forEach(d => {
      const r = d.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.email || ""}</td>
        <td style="font-family:monospace;font-size:12px">${r.uid}</td>
        <td>${r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : ""}</td>
        <td>
          <button class="btn ok" data-uid="${r.uid}" data-email="${r.email}">‚úÖ Activer</button>
          <button class="btn no" data-uid="${r.uid}">‚ùå Refuser</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ‚úÖ Activer / Refuser
  tbody.addEventListener("click", async (e) => {
    const btn = e.target.closest("button");
    if (!btn) return;

    const uid = btn.dataset.uid;
    const email = btn.dataset.email || "";

    try {
      if (btn.classList.contains("ok")) {
        // 1) Cr√©er/MAJ la fiche "users/{uid}"
        await setDoc(doc(db, "users", uid), {
          uid,
          email,
          role: "AGENT",
          status: "ACTIF",
          activatedAt: serverTimestamp()
        }, { merge: true });

        // 2) Marquer la demande comme trait√©e
        await updateDoc(doc(db, "user_requests", uid), { status: "APPROVED" });

        setMsg("‚úÖ Compte activ√© : " + email, true);
      }

      if (btn.classList.contains("no")) {
        await updateDoc(doc(db, "user_requests", uid), { status: "REFUSED" });
        setMsg("‚ùå Demande refus√©e.", false);
      }

      await loadPending();

    } catch (err) {
      setMsg("Erreur : " + err.message, false);
    }
  });

  document.getElementById("btnLogout").onclick = async () => {
    await signOut(auth);
    window.location.href = "login.html";
  };

  loadPending();
</script>

</body>
</html>
